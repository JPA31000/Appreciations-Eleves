<!DOCTYPE html>
<html lang="fr" class="h-full bg-slate-100">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Évaluation des Élèves</title>
    <!-- Chargement de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 
      Import map pour charger des modules JavaScript comme 'jspdf'.
    -->
    <script type="importmap">
      {
        "imports": {
          "jspdf": "https://aistudiocdn.com/jspdf@^2.5.1"
        }
      }
    </script>
    <style>
      /* Ajout de quelques styles pour améliorer l'expérience */
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
      }
      /* Style pour la scrollbar de la liste des élèves */
      #student-list-container::-webkit-scrollbar {
        width: 6px;
      }
      #student-list-container::-webkit-scrollbar-thumb {
        background-color: #cbd5e1; /* slate-300 */
        border-radius: 3px;
      }
      #student-list-container::-webkit-scrollbar-track {
        background-color: #f1f5f9; /* slate-100 */
      }
    </style>
  </head>
  <body class="h-full m-0">
    <!-- 
      La structure HTML principale de l'application.
    -->
    <div id="app-root" class="h-screen w-screen flex flex-col font-sans">
      <header class="w-full bg-white shadow-md z-10 print:hidden">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex flex-wrap justify-between items-center gap-3">
          <div class="flex items-center gap-4 flex-wrap">
            <h1 class="text-2xl font-bold text-slate-900">Avis Élèves</h1>
            <!-- Sélecteur de période -->
            <div id="period-selector" class="flex items-center gap-1 rounded-md bg-slate-100 p-1 border border-slate-200">
              <!-- Les boutons radio seront insérés ici par JS -->
            </div>
            <!-- Bouton d'export PDF -->
            <button
              id="export-pdf-button"
              class="px-4 py-2 bg-slate-700 text-white font-semibold rounded-md shadow-sm hover:bg-slate-800 transition-colors flex items-center gap-2 text-sm"
            >
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path d="M10.75 2.75a.75.75 0 00-1.5 0v8.614L6.295 8.235a.75.75 0 10-1.09 1.03l4.25 4.5a.75.75 0 001.09 0l4.25-4.5a.75.75 0 00-1.09-1.03l-2.955 3.129V2.75z" />
                <path d="M3.5 12.75a.75.75 0 00-1.5 0v2.5A2.75 2.75 0 004.75 18h10.5A2.75 2.75 0 0018 15.25v-2.5a.75.75 0 00-1.5 0v2.5c0 .69-.56 1.25-1.25 1.25H4.75c-.69 0-1.25-.56-1.25-1.25v-2.5z" />
              </svg>
              <span>Exporter la classe (PDF)</span>
            </button>
            <!-- Bouton d'aide (Guide d'utilisation) -->
            <button
              id="help-button"
              class="p-2 bg-sky-600 text-white font-bold rounded-full shadow-sm hover:bg-sky-700 transition-colors flex items-center justify-center text-sm w-8 h-8"
              title="Guide d'utilisation"
            >
              ?
            </button>
          </div>
          <!-- Sélecteur d'enseignant -->
          <div class="flex items-center space-x-3">
            <label for="teacher-select" class="text-sm font-medium text-slate-700 whitespace-nowrap">
              Connecté en tant que :
            </label>
            <select
              id="teacher-select"
              class="block w-full max-w-xs pl-3 pr-10 py-2 text-base border-slate-300 focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm rounded-md shadow-sm"
            >
              <!-- Les options d'enseignants seront insérées ici par JS -->
            </select>
          </div>
        </div>
      </header>
      <main class="flex-grow flex flex-col md:flex-row overflow-hidden">
        <!-- Conteneur pour la liste des élèves (StudentList) -->
        <div id="student-list-container" class="w-full md:w-1/3 lg:w-1/4 bg-white border-r border-slate-200 h-full overflow-y-auto print:hidden">
          <!-- Le contenu sera généré par renderStudentList() -->
        </div>
        <!-- Conteneur pour le formulaire d'avis (FeedbackForm) -->
        <div id="feedback-form-container" class="w-full md:w-2/3 lg:w-3/4 bg-slate-50 h-full overflow-y-auto p-6 md:p-8">
          <!-- Le contenu sera généré par renderFeedbackForm() -->
        </div>
      </main>
    </div>

    <!-- Modal de Guide d'utilisation -->
    <div id="help-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center p-4">
      <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto z-50">
        <!-- En-tête du modal -->
        <div class="flex justify-between items-center p-4 border-b">
          <h3 class="text-xl font-bold text-slate-800">Guide d'utilisation</h3>
          <button id="close-modal-button" class="text-slate-500 hover:text-slate-800 font-bold text-2xl">&times;</button>
        </div>
        <!-- Contenu du modal -->
        <div class="p-6">
          <ol class="list-decimal list-inside space-y-3 text-slate-700">
            <li>Je choisis le type de semestre (ex: S1, S2...).</li>
            <li>Je me connecte en tant que professeur (voir menu déroulant).</li>
            <li>Je sélectionne l'élève dans la liste de gauche.</li>
            <li>Je choisis les appréciations (Qualité du travail, Comportement...).
              <br><small class="text-slate-500">(Il n'est pas obligatoire de compléter tous les items.)</small>
            </li>
            <li>Je laisse un commentaire (facultatif).</li>
            <li>
              <strong>Pensez à enregistrer l'avis</strong> pour chaque élève. Un rond vert apparaît en face du nom de l'élève.
              <br><small class="text-slate-500">(Note: Pour le RGPD, l'enregistrement se fait sur la mémoire tampon de votre PC, il n'est pas stocké en ligne.)</small>
            </li>
            <li>Je complète les avis pour l'ensemble (ou une partie) des élèves.</li>
            <li>Une fois terminé, je clique sur "Exporter la classe (PDF)" en haut de la page.</li>
            <li>J'envoie le PDF à Jean-Philippe qui fera une synthèse.</li>
          </ol>
        </div>
      </div>
    </div>
    <!-- Fin du Modal -->


    <!-- 
      Début du script JavaScript
      Ce script contient toute la logique de l'application.
    -->
    <script type="module">
      // Importation de jsPDF depuis l'import map
      import jsPDF from 'jspdf';

      // --- Définition des Constantes (Similaire à types.ts et constants.ts) ---

      // --- NOUVELLES LISTES DE QUALIFICATIFS ---
      // (Basé sur qualificatifs_evaluation.md)

      const NON_EVALUE = "Non évalué";

      const TRAVAIL_OPTIONS = [
        { value: NON_EVALUE, label: NON_EVALUE, color: "text-slate-500" },
        // Positifs
        { value: "Assidu", label: "Assidu", color: "text-green-600" },
        { value: "Méthodique", label: "Méthodique", color: "text-green-600" },
        { value: "Rigoureux", label: "Rigoureux", color: "text-green-600" },
        { value: "Autonome", label: "Autonome", color: "text-green-600" },
        { value: "Organisé", label: "Organisé", color: "text-green-600" },
        { value: "Consciencieux", label: "Consciencieux", color: "text-green-600" },
        { value: "Investi", label: "Investi", color: "text-green-600" },
        { value: "Soutenu", label: "Soutenu", color: "text-green-600" },
        { value: "Sérieux", label: "Sérieux", color: "text-sky-600" },
        { value: "Régulier", label: "Régulier", color: "text-sky-600" },
        { value: "Volontaire", label: "Volontaire", color: "text-sky-600" },
        { value: "Soigné", label: "Soigné", color: "text-sky-600" },
        { value: "Appliqué", label: "Appliqué", color: "text-sky-600" },
        { value: "Précis", label: "Précis", color: "text-sky-600" },
        { value: "Impliqué", label: "Impliqué", color: "text-sky-600" },
        { value: "Ordonné", label: "Ordonné", color: "text-sky-600" },
        // Neutres
        { value: "Inégal", label: "Inégal", color: "text-amber-600" },
        { value: "Irrégulier", label: "Irrégulier", color: "text-amber-600" },
        { value: "Ponctuel", label: "Ponctuel", color: "text-amber-600" },
        { value: "À encourager", label: "À encourager", color: "text-amber-600" },
        { value: "Souvent distrait", label: "Souvent distrait", color: "text-amber-600" },
        { value: "Peut mieux faire", label: "Peut mieux faire", color: "text-amber-600" },
        // Négatifs
        { value: "Passif", label: "Passif", color: "text-red-600" },
        { value: "Désinvesti", label: "Désinvesti", color: "text-red-600" },
        { value: "Peu attentif", label: "Peu attentif", color: "text-red-600" },
        { value: "Rendu incomplet/tardif", label: "Rendu incomplet/tardif", color: "text-red-600" },
        { value: "Bâclé", label: "Bâclé", color: "text-red-600" },
        { value: "Manque de persévérance", label: "Manque de persévérance", color: "text-red-600" },
        { value: "Négligé", label: "Négligé", color: "text-red-600" },
        { value: "Superficiel", label: "Superficiel", color: "text-red-600" },
        { value: "Désordonné", label: "Désordonné", color: "text-red-600" },
        { value: "Manque d'approfondissement", label: "Manque d'approfondissement", color: "text-red-600" },
      ];

      const ATTITUDE_OPTIONS = [
        { value: NON_EVALUE, label: NON_EVALUE, color: "text-slate-500" },
        // Positifs
        { value: "Constructif", label: "Constructif", color: "text-green-600" },
        { value: "Engagé", label: "Engagé", color: "text-green-600" },
        { value: "Enthousiaste", label: "Enthousiaste", color: "text-green-600" },
        { value: "Curieux", label: "Curieux", color: "text-green-600" },
        { value: "Respectueux", label: "Respectueux", color: "text-green-600" },
        { value: "Coopératif", label: "Coopératif", color: "text-green-600" },
        { value: "Ouvert", label: "Ouvert", color: "text-green-600" },
        { value: "Stimulant", label: "Stimulant", color: "text-green-600" },
        { value: "Bienveillant", label: "Bienveillant", color: "text-green-600" },
        { value: "Courtois", label: "Courtois", color: "text-sky-600" },
        { value: "Participatif", label: "Participatif", color: "text-sky-600" },
        { value: "Attentif", label: "Attentif", color: "text-sky-600" },
        { value: "Poli", label: "Poli", color: "text-sky-600" },
        { value: "Intéressé", label: "Intéressé", color: "text-sky-600" },
        { value: "Sociable", label: "Sociable", color: "text-sky-600" },
        // Neutres
        { value: "Réservé", label: "Réservé", color: "text-amber-600" },
        { value: "Discret", label: "Discret", color: "text-amber-600" },
        { value: "Silence/mutisme", label: "Silence/mutisme", color: "text-amber-600" },
        { value: "Variable selon le sujet/jour", label: "Variable selon le sujet/jour", color: "text-amber-600" },
        { value: "Parfois agité", label: "Parfois agité", color: "text-amber-600" },
        { value: "Demande à être recadré", label: "Demande à être recadré", color: "text-amber-600" },
        // Négatifs
        { value: "Bavard", label: "Bavard", color: "text-red-600" },
        { value: "Interventions inappropriées", label: "Interventions inappropriées", color: "text-red-600" },
        { value: "Peut faire preuve d'impertinence", label: "Peut faire preuve d'impertinence", color: "text-red-600" },
        { value: "Oppositionnel", label: "Oppositionnel", color: "text-red-600" },
        { value: "Provocateur", label: "Provocateur", color: "text-red-600" },
        { value: "Perturbateur", label: "Perturbateur", color: "text-red-600" },
        { value: "Nonchalant", label: "Nonchalant", color: "text-red-600" },
        { value: "Manque de respect flagrant", label: "Manque de respect flagrant", color: "text-red-600" },
        { value: "Retrait/isolement excessif", label: "Retrait/isolement excessif", color: "text-red-600" },
      ];

      const DIFFICULTE_COMPREHENSION_OPTIONS = [
        { value: NON_EVALUE, label: NON_EVALUE, color: "text-slate-500" },
        { value: "Aisé", label: "Aisé", color: "text-green-600" },
        { value: "Rapide", label: "Rapide", color: "text-green-600" },
        { value: "Clair", label: "Clair", color: "text-green-600" },
        { value: "Profond", label: "Profond", color: "text-green-600" },
        { value: "Laborieux", label: "Laborieux", color: "text-red-600" },
        { value: "Lent", label: "Lent", color: "text-red-600" },
        { value: "Superficiel", label: "Superficiel", color: "text-red-600" },
        { value: "Confus", label: "Confus", color: "text-red-600" },
      ];
      
      const DIFFICULTE_LOGIQUE_OPTIONS = [
        { value: NON_EVALUE, label: NON_EVALUE, color: "text-slate-500" },
        { value: "Pertinent", label: "Pertinent", color: "text-green-600" },
        { value: "Structuré", label: "Structuré", color: "text-green-600" },
        { value: "Synthétique", label: "Synthétique", color: "text-green-600" },
        { value: "Analytique", label: "Analytique", color: "text-green-600" },
        { value: "Illogique", label: "Illogique", color: "text-red-600" },
        { value: "Décousu", label: "Décousu", color: "text-red-600" },
        { value: "Manque de méthode", label: "Manque de méthode", color: "text-red-600" },
      ];

      const DIFFICULTE_ACQUISITION_OPTIONS = [
        { value: NON_EVALUE, label: NON_EVALUE, color: "text-slate-500" },
        { value: "Solide", label: "Solide", color: "text-green-600" },
        { value: "Bien ancré", label: "Bien ancré", color: "text-green-600" },
        { value: "Maîtrisé", label: "Maîtrisé", color: "text-green-600" },
        { value: "Fragile", label: "Fragile", color: "text-red-600" },
        { value: "Éphémère", label: "Éphémère", color: "text-red-600" },
        { value: "Lacunes importantes", label: "Lacunes importantes", color: "text-red-600" },
      ];

      const DIFFICULTE_POTENTIEL_OPTIONS = [
        { value: NON_EVALUE, label: NON_EVALUE, color: "text-slate-500" },
        { value: "Prometteur", label: "Prometteur", color: "text-green-600" },
        { value: "Évolutif", label: "Évolutif", color: "text-green-600" },
        { value: "Progresse rapidement", label: "Progresse rapidement", color: "text-green-600" },
        { value: "Marge de progression importante", label: "Marge de progression importante", color: "text-green-600" },
        { value: "Progression limitée", label: "Progression limitée", color: "text-red-600" },
        { value: "Pédagogie à ajuster", label: "Pédagogie à ajuster", color: "text-red-600" },
        { value: "Difficultés persistantes", label: "Difficultés persistantes", color: "text-red-600" },
      ];

      const DIFFICULTE_GESTION_ERREURS_OPTIONS = [
        { value: NON_EVALUE, label: NON_EVALUE, color: "text-slate-500" },
        { value: "Critique", label: "Critique", color: "text-green-600" },
        { value: "Remédiation efficace", label: "Remédiation efficace", color: "text-green-600" },
        { value: "Capacité à s'auto-corriger", label: "Capacité à s'auto-corriger", color: "text-green-600" },
        { value: "Répétition des erreurs", label: "Répétition des erreurs", color: "text-red-600" },
        { value: "Ne se remet pas en question", label: "Ne se remet pas en question", color: "text-red-600" },
        { value: "Refus d'aide", label: "Refus d'aide", color: "text-red-600" },
      ];

      // --- Listes d'entités ---
      
      const ENSEIGNANTS = [
        { id: 1, nom: "M. AMAT" },
        { id: 2, nom: "M. DOUMAGNAC" },
        { id: 3, nom: "MME MEZURE" },
        { id: 4, nom: "MME LATTES" },
        { id: 5, nom: "MME MOUSSI BOUNAOUARA" },
        { id: 6, nom: "MME LAMI" },
        { id: 7, nom: "M. INTILE" },
        { id: 8, nom: "MME BUSSER" },
        { id: 9, nom: "MME SANCHEZ" },
      ];

      // NOUVELLE structure pour l'avis initial
      const AVIS_INITIAL = {
        travail: NON_EVALUE,
        comportement: NON_EVALUE,
        attitude: NON_EVALUE,
        difficulte_comprehension: NON_EVALUE,
        difficulte_logique: NON_EVALUE,
        difficulte_acquisition: NON_EVALUE,
        difficulte_potentiel: NON_EVALUE,
        difficulte_gestion_erreurs: NON_EVALUE,
        commentaires: ""
      };

      // Liste des élèves mise à jour
      const ELEVES_INITIAUX = [
        { id: 1, nom: "ABDELMAJID", prenom: "Khadija", avis: [] },
        { id: 2, nom: "BABI", prenom: "Nour", avis: [] },
        { id: 3, nom: "BELHADI", prenom: "Mélissa", avis: [] },
        { id: 4, nom: "BOUKHIAR", prenom: "Fatima", avis: [] },
        { id: 5, nom: "CHARLES", prenom: "Glory", avis: [] },
        { id: 6, nom: "DESLONG", prenom: "Rayane Bamba", avis: [] },
        { id: 7, nom: "DEVILLE", prenom: "Chloé", avis: [] },
        { id: 8, nom: "EGLELA", prenom: "Orlane", avis: [] },
        { id: 9, nom: "EL ASRI", prenom: "Ayman", avis: [] },
        { id: 10, nom: "GUELLOULI", prenom: "Malak", avis: [] },
        { id: 11, nom: "HASSANI", prenom: "Killyann", avis: [] },
        { id: 12, nom: "INSELIN", prenom: "Enzo", avis: [] },
        { id: 13, nom: "JILAVU", prenom: "Maria-Teodora", avis: [] },
        { id: 14, nom: "JOJUA", prenom: "Giorgi", avis: [] },
        { id: 15, nom: "KHACHATRIAN", prenom: "Angelina", avis: [] },
        { id: 16, nom: "KONNEH", prenom: "Karamba", avis: [] },
        { id: 17, nom: "LUNIMBU", prenom: "Fernanda", avis: [] },
        { id: 18, nom: "MUNIER", prenom: "Kelly", avis: [] },
        { id: 19, nom: "OUERFELLI", prenom: "Samia", avis: [] },
        { id: 20, nom: "POUGIN", prenom: "Pharel", avis: [] },
        { id: 21, nom: "QACHRI", prenom: "Adam", avis: [] },
        { id: 22, nom: "ROUQUETTE", prenom: "Noa", avis: [] },
        { id: 23, nom: "TAYEB PACHA", prenom: "Romayssa", avis: [] },
        { id: 24, nom: "TOUATI", prenom: "Ranim", avis: [] },
        { id: 25, nom: "YANG", prenom: "Danny", avis: [] },
      ];

      const PERIODES = ['mi-S1', 'S1', 'mi-S2', 'S2'];

      // --- État de l'application (similaire à useState) ---
      
      // Fonction pour charger l'état depuis localStorage (simule la mémoire tampon)
      function loadStateFromStorage() {
        try {
          const storedState = localStorage.getItem('studentFeedbackAppState');
          if (storedState) {
            const parsedState = JSON.parse(storedState);
            // Assurer la compatibilité ascendante si la structure de l'avis a changé
            parsedState.eleves.forEach(eleve => {
              eleve.avis.forEach(avisItem => {
                // Si l'avis est ancien ou n'a pas les nouveaux champs, on le réinitialise/met à jour
                if (avisItem.avis && typeof avisItem.avis.difficulte_comprehension === 'undefined') {
                   // Copie les anciennes valeurs si elles existent, sinon utilise AVIS_INITIAL
                   const oldAvis = avisItem.avis;
                   avisItem.avis = JSON.parse(JSON.stringify(AVIS_INITIAL));
                   avisItem.avis.travail = oldAvis.travail || NON_EVALUE;
                   avisItem.avis.comportement = oldAvis.comportement || NON_EVALUE;
                   avisItem.avis.attitude = oldAvis.attitude || NON_EVALUE;
                   avisItem.avis.commentaires = oldAvis.commentaires || "";
                }
              });
            });
            return parsedState;
          }
        } catch (error) {
          console.error("Erreur lors de la lecture du localStorage:", error);
        }
        // État initial par défaut
        return {
          eleves: JSON.parse(JSON.stringify(ELEVES_INITIAUX)),
          selectedEleveId: ELEVES_INITIAUX[0]?.id ?? null,
          currentEnseignantId: ENSEIGNANTS[0]?.id ?? null,
          selectedPeriod: 'S1',
        };
      }
      
      // Fonction pour sauvegarder l'état dans localStorage
      function saveStateToStorage() {
        try {
          localStorage.setItem('studentFeedbackAppState', JSON.stringify(state));
        } catch (error)
        {
          console.error("Erreur lors de l'écriture dans le localStorage:", error);
        }
      }

      // Initialisation de l'état
      const state = loadStateFromStorage();


      // --- Fonctions de Rendu (similaires aux composants React) ---

      /**
       * M-à-j et affiche la liste des élèves (StudentList).
       */
      function renderStudentList() {
        const container = document.getElementById('student-list-container');
        if (!container) return;

        container.innerHTML = ''; // Vide le conteneur

        const sortedEleves = [...state.eleves].sort((a, b) => a.nom.localeCompare(b.nom));

        sortedEleves.forEach(eleve => {
          const isSelected = eleve.id === state.selectedEleveId;
          const avisEnseignant = eleve.avis.find(a => a.enseignantId === state.currentEnseignantId);
          
          // Vérifie si l'avis est considéré comme "complété"
          const hasAvis = avisEnseignant && (
            avisEnseignant.avis.travail !== NON_EVALUE ||
            avisEnseignant.avis.comportement !== NON_EVALUE ||
            avisEnseignant.avis.attitude !== NON_EVALUE ||
            avisEnseignant.avis.difficulte_comprehension !== NON_EVALUE ||
            avisEnseignant.avis.difficulte_logique !== NON_EVALUE ||
            avisEnseignant.avis.difficulte_acquisition !== NON_EVALUE ||
            avisEnseignant.avis.difficulte_potentiel !== NON_EVALUE ||
            avisEnseignant.avis.difficulte_gestion_erreurs !== NON_EVALUE ||
            (avisEnseignant.avis.commentaires && avisEnseignant.avis.commentaires.trim() !== "")
          );

          const studentDiv = document.createElement('div');
          studentDiv.className = `px-4 py-3 cursor-pointer border-b border-slate-200 ${
            isSelected ? 'bg-sky-100' : 'hover:bg-slate-50'
          }`;
          
          studentDiv.innerHTML = `
            <div class="flex justify-between items-center">
              <span class="font-medium ${isSelected ? 'text-sky-700' : 'text-slate-800'}">
                ${eleve.nom} ${eleve.prenom}
              </span>
              ${hasAvis ? 
                `<span title="Avis complété" class="h-3 w-3 bg-green-500 rounded-full flex-shrink-0"></span>` : 
                `<span title="Avis non complété" class="h-3 w-3 bg-slate-300 rounded-full flex-shrink-0"></span>`
              }
            </div>
          `;

          // Ajoute le gestionnaire d'événement pour la sélection
          studentDiv.addEventListener('click', () => {
            handleSelectEleve(eleve.id);
          });

          container.appendChild(studentDiv);
        });
      }

      /**
       * M-à-j et affiche le formulaire d'avis (FeedbackForm).
       */
      function renderFeedbackForm() {
        const container = document.getElementById('feedback-form-container');
        if (!container) return;

        const selectedEleve = state.eleves.find(e => e.id === state.selectedEleveId);
        
        if (!selectedEleve || !state.currentEnseignantId) {
          container.innerHTML = `
            <div class="flex items-center justify-center h-full">
              <div class="text-center text-slate-500 p-8">
                <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="1">
                    <path strokeLinecap="round" strokeLinejoin="round" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M15 21v-1a6 6 0 00-5.176-5.97M15 21v-1a6 6 0 00-9-5.197m0 0A11.95 11.95 0 0012 13a11.95 11.95 0 00-3-5.197m-6 0A11.95 11.95 0 0012 13a11.95 11.95 0 006-5.197M12 13a4 4 0 110-5.292 4 4 0 010 5.292z" />
                </svg>
                <h3 class="mt-2 text-lg font-medium text-slate-700">Prêt à commencer</h3>
                <p class="mt-1 text-sm text-slate-500">
                  Veuillez sélectionner un élève dans la liste à gauche.
                </p>
              </div>
            </div>
          `;
          return;
        }

        // Trouve l'avis existant ou utilise l'avis initial
        const existingAvis = selectedEleve.avis.find(a => a.enseignantId === state.currentEnseignantId)?.avis ?? JSON.parse(JSON.stringify(AVIS_INITIAL));
        const enseignant = ENSEIGNANTS.find(e => e.id === state.currentEnseignantId);

        // Crée les options pour les listes déroulantes
        const createOptions = (options, selectedValue) => {
          return options.map(opt => 
            `<option value="${opt.value}" ${opt.value === selectedValue ? 'selected' : ''}>${opt.label}</option>`
          ).join('');
        };
        
        // Crée le HTML pour chaque liste d'options
        const travailOptionsHtml = createOptions(TRAVAIL_OPTIONS, existingAvis.travail);
        const comportementOptionsHtml = createOptions(ATTITUDE_OPTIONS, existingAvis.comportement);
        const attitudeOptionsHtml = createOptions(ATTITUDE_OPTIONS, existingAvis.attitude);
        
        const diffComprehensionHtml = createOptions(DIFFICULTE_COMPREHENSION_OPTIONS, existingAvis.difficulte_comprehension);
        const diffLogiqueHtml = createOptions(DIFFICULTE_LOGIQUE_OPTIONS, existingAvis.difficulte_logique);
        const diffAcquisitionHtml = createOptions(DIFFICULTE_ACQUISITION_OPTIONS, existingAvis.difficulte_acquisition);
        const diffPotentielHtml = createOptions(DIFFICULTE_POTENTIEL_OPTIONS, existingAvis.difficulte_potentiel);
        const diffGestionErreursHtml = createOptions(DIFFICULTE_GESTION_ERREURS_OPTIONS, existingAvis.difficulte_gestion_erreurs);


        // Crée le HTML du formulaire
        container.innerHTML = `
          <div class="max-w-3xl mx-auto">
            <h2 class="text-3xl font-bold text-slate-800 mb-2">
              ${selectedEleve.prenom} ${selectedEleve.nom}
            </h2>
            <p class="text-lg text-slate-600 mb-6">
              Avis de: <span class="font-semibold text-slate-700">${enseignant.nom}</span>
              <span class="text-slate-400 mx-2">|</span>
              Période: <span class="font-semibold text-slate-700">${state.selectedPeriod.toUpperCase()}</span>
            </p>

            <form id="feedback-form" class="space-y-6">
              <!-- Section Qualité du travail -->
              <div>
                <label for="avis-travail" class="block text-sm font-medium text-slate-700 mb-1">
                  Qualité du travail
                </label>
                <select id="avis-travail" class="block w-full rounded-md border-slate-300 shadow-sm focus:border-sky-500 focus:ring-sky-500 sm:text-sm">
                  ${travailOptionsHtml}
                </select>
              </div>

              <!-- Section Comportement en classe -->
              <div>
                <label for="avis-comportement" class="block text-sm font-medium text-slate-700 mb-1">
                  Comportement en classe
                </label>
                <select id="avis-comportement" class="block w-full rounded-md border-slate-300 shadow-sm focus:border-sky-500 focus:ring-sky-500 sm:text-sm">
                  ${comportementOptionsHtml}
                </select>
              </div>

              <!-- Section Attitude -->
              <div>
                <label for="avis-attitude" class="block text-sm font-medium text-slate-700 mb-1">
                  Attitude (sérieux, implication)
                </label>
                <select id="avis-attitude" class="block w-full rounded-md border-slate-300 shadow-sm focus:border-sky-500 focus:ring-sky-500 sm:text-sm">
                  ${attitudeOptionsHtml}
                </select>
              </div>

              <!-- NOUVELLE Section Difficultés (divisée) -->
              <div class="border-t border-slate-200 pt-6">
                <h3 class="text-lg font-medium text-slate-800 mb-4">Analyse des Difficultés / Progression</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                  
                  <div>
                    <label for="avis-diff-comprehension" class="block text-sm font-medium text-slate-700 mb-1">
                      Compréhension
                    </label>
                    <select id="avis-diff-comprehension" class="block w-full rounded-md border-slate-300 shadow-sm focus:border-sky-500 focus:ring-sky-500 sm:text-sm">
                      ${diffComprehensionHtml}
                    </select>
                  </div>

                  <div>
                    <label for="avis-diff-logique" class="block text-sm font-medium text-slate-700 mb-1">
                      Logique / Raisonnement
                    </label>
                    <select id="avis-diff-logique" class="block w-full rounded-md border-slate-300 shadow-sm focus:border-sky-500 focus:ring-sky-500 sm:text-sm">
                      ${diffLogiqueHtml}
                    </select>
                  </div>

                  <div>
                    <label for="avis-diff-acquisition" class="block text-sm font-medium text-slate-700 mb-1">
                      Acquisition des savoirs
                    </label>
                    <select id="avis-diff-acquisition" class="block w-full rounded-md border-slate-300 shadow-sm focus:border-sky-500 focus:ring-sky-500 sm:text-sm">
                      ${diffAcquisitionHtml}
                    </select>
                  </div>

                  <div>
                    <label for="avis-diff-potentiel" class="block text-sm font-medium text-slate-700 mb-1">
                      Potentiel / Progression
                    </label>
                    <select id="avis-diff-potentiel" class="block w-full rounded-md border-slate-300 shadow-sm focus:border-sky-500 focus:ring-sky-500 sm:text-sm">
                      ${diffPotentielHtml}
                    </select>
                  </div>

                  <div class="md:col-span-2">
                    <label for="avis-diff-gestion-erreurs" class="block text-sm font-medium text-slate-700 mb-1">
                      Gestion des erreurs
                    </label>
                    <select id="avis-diff-gestion-erreurs" class="block w-full rounded-md border-slate-300 shadow-sm focus:border-sky-500 focus:ring-sky-500 sm:text-sm">
                      ${diffGestionErreursHtml}
                    </select>
                  </div>

                </div>
              </div>

              <!-- Section Commentaires -->
              <div class="border-t border-slate-200 pt-6">
                <label for="avis-commentaires" class="block text-sm font-medium text-slate-700 mb-1">
                  Commentaire (facultatif)
                </label>
                <textarea id="avis-commentaires" rows="4" class="block w-full rounded-md border-slate-300 shadow-sm focus:border-sky-500 focus:ring-sky-500 sm:text-sm">${existingAvis.commentaires}</textarea>
              </div>
              
              <!-- Bouton de sauvegarde -->
              <div class="text-right pt-4">
                <button type="submit" id="save-avis-button" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-sky-600 hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500">
                  Enregistrer l'avis
                </button>
              </div>
            </form>
          </div>
        `;

        // Ajoute le gestionnaire d'événement au formulaire
        document.getElementById('feedback-form').addEventListener('submit', (e) => {
          e.preventDefault(); // Empêche le rechargement de la page
          handleSaveAvis();
        });
      }

      /**
       * M-à-j et affiche les sélecteurs (période, enseignant).
       */
      function renderSelectors() {
        // Sélecteur d'enseignant
        const teacherSelect = document.getElementById('teacher-select');
        if (teacherSelect) {
          teacherSelect.innerHTML = ENSEIGNANTS.map(ens => 
            `<option value="${ens.id}" ${ens.id === state.currentEnseignantId ? 'selected' : ''}>${ens.nom}</option>`
          ).join('');
        }

        // Sélecteur de période
        const periodSelector = document.getElementById('period-selector');
        if (periodSelector) {
          periodSelector.innerHTML = PERIODES.map(period => `
            <label class="px-3 py-1 text-sm font-medium rounded cursor-pointer transition-colors ${state.selectedPeriod === period ? 'bg-white text-sky-700 shadow-sm' : 'text-slate-600 hover:bg-slate-200'}">
              <input
                type="radio"
                name="period"
                value="${period}"
                ${state.selectedPeriod === period ? 'checked' : ''}
                class="sr-only"
              />
              ${period.toUpperCase()}
            </label>
          `).join('');
          
          // Ajoute les écouteurs d'événements aux nouveaux boutons radio
          periodSelector.querySelectorAll('input[name="period"]').forEach(input => {
            input.addEventListener('change', handlePeriodChange);
          });
        }
      }

      /**
       * Fonction de rendu principale qui met à jour tout l'UI.
       */
      function renderApp() {
        renderSelectors();
        renderStudentList();
        renderFeedbackForm();
        // Sauvegarde l'état après chaque rendu
        saveStateToStorage(); 
      }

      // --- Gestionnaires d'Événements ---

      /**
       * Appelé lors de la sélection d'un élève.
       */
      function handleSelectEleve(id) {
        state.selectedEleveId = id;
        renderFeedbackForm();
        renderStudentList(); // Re-render pour la surbrillance
      }

      /**
       * Appelé lors du changement d'enseignant.
       */
      function handleTeacherChange(event) {
        state.currentEnseignantId = parseInt(event.target.value, 10);
        renderApp(); // Re-rendu complet
      }

      /**
       * Appelé lors du changement de période.
       */
      function handlePeriodChange(event) {
        state.selectedPeriod = event.target.value;
        renderApp(); // Re-rendu complet
      }

      /**
       * Appelé lors de la sauvegarde du formulaire d'avis.
       */
      function handleSaveAvis() {
        if (!state.selectedEleveId || !state.currentEnseignantId) return;

        // Récupère les valeurs du formulaire
        const updatedAvis = {
          travail: document.getElementById('avis-travail').value,
          comportement: document.getElementById('avis-comportement').value,
          attitude: document.getElementById('avis-attitude').value,
          // Nouveaux champs de difficultés
          difficulte_comprehension: document.getElementById('avis-diff-comprehension').value,
          difficulte_logique: document.getElementById('avis-diff-logique').value,
          difficulte_acquisition: document.getElementById('avis-diff-acquisition').value,
          difficulte_potentiel: document.getElementById('avis-diff-potentiel').value,
          difficulte_gestion_erreurs: document.getElementById('avis-diff-gestion-erreurs').value,
          // Champ commentaire
          commentaires: document.getElementById('avis-commentaires').value,
        };

        // M-à-j l'état (imitation de l'immuabilité)
        state.eleves = state.eleves.map(eleve => {
          if (eleve.id !== state.selectedEleveId) {
            return eleve;
          }

          const existingAvisIndex = eleve.avis.findIndex(a => a.enseignantId === state.currentEnseignantId);
          const newAvisArray = [...eleve.avis];

          if (existingAvisIndex > -1) {
            newAvisArray[existingAvisIndex] = { enseignantId: state.currentEnseignantId, avis: updatedAvis };
          } else {
            newAvisArray.push({ enseignantId: state.currentEnseignantId, avis: updatedAvis });
          }
          
          return { ...eleve, avis: newAvisArray };
        });

        // Affiche une confirmation visuelle
        const saveButton = document.getElementById('save-avis-button');
        const originalText = saveButton.innerHTML;
        saveButton.innerHTML = 'Enregistré !';
        saveButton.classList.add('bg-green-600', 'hover:bg-green-700');
        saveButton.classList.remove('bg-sky-600', 'hover:bg-sky-700');

        setTimeout(() => {
          saveButton.innerHTML = originalText;
          saveButton.classList.remove('bg-green-600', 'hover:bg-green-700');
          saveButton.classList.add('bg-sky-600', 'hover:bg-sky-700');
        }, 1500);

        // Met à jour la liste des élèves pour afficher la pastille de statut et sauvegarde l'état
        renderApp();
      }

      /**
       * Gère l'export PDF (mis à jour pour la nouvelle structure).
       */
      function handleExportClassePDF() {
        const doc = new jsPDF();
        let y = 15;
        const pageHeight = doc.internal.pageSize.height;
        const margin = 15;
        const contentWidth = doc.internal.pageSize.width - (margin * 2);

        doc.setFontSize(20);
        doc.text(`Rapport d'appréciations de la Classe - ${state.selectedPeriod.toUpperCase()}`, 105, y, { align: 'center' });
        y += 8;
        doc.setFontSize(12);
        doc.text(`Date: ${new Date().toLocaleDateString('fr-FR')}`, 105, y, { align: 'center' });
        y += 15;

        const sortedEleves = [...state.eleves].sort((a, b) => a.nom.localeCompare(b.nom));

        sortedEleves.forEach((eleve) => {
          if (eleve.avis.length > 0) {
            if (y > pageHeight - 50) {
              doc.addPage();
              y = margin;
            }

            if (y > 38) {
                doc.setLineWidth(0.2);
                doc.line(margin, y - 5, margin + contentWidth, y - 5);
            }

            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text(`${eleve.nom} ${eleve.prenom}`, margin, y);
            y += 10;

            eleve.avis.forEach(avisEnseignant => {
              const enseignant = ENSEIGNANTS.find(e => e.id === avisEnseignant.enseignantId);
              if (enseignant) {
                if (y > pageHeight - 60) {
                  doc.addPage();
                  y = margin;
                  doc.setFontSize(16);
                  doc.setFont('helvetica', 'bold');
                  doc.text(`${eleve.nom} ${eleve.prenom} (suite)`, margin, y);
                  y += 10;
                }

                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text(`Avis de : ${enseignant.nom}`, margin + 5, y);
                y += 7;

                doc.setFont('helvetica', 'normal');
                doc.setFontSize(10);
                
                const addSection = (title, value) => {
                  if (value && value !== NON_EVALUE) {
                    if (y > pageHeight - margin) {
                      doc.addPage();
                      y = margin;
                    }
                    doc.text(`- ${title}:`, margin + 10, y);
                    doc.text(value, margin + 60, y);
                    y += 6;
                  }
                };
                
                addSection("Qualité du travail", avisEnseignant.avis.travail);
                addSection("Comportement en classe", avisEnseignant.avis.comportement);
                addSection("Attitude", avisEnseignant.avis.attitude);
                
                // Ajout des nouvelles sections de difficultés
                addSection("Difficultés (Compréhension)", avisEnseignant.avis.difficulte_comprehension);
                addSection("Difficultés (Logique)", avisEnseignant.avis.difficulte_logique);
                addSection("Difficultés (Acquisition)", avisEnseignant.avis.difficulte_acquisition);
                addSection("Difficultés (Potentiel)", avisEnseignant.avis.difficulte_potentiel);
                addSection("Difficultés (Gestion erreurs)", avisEnseignant.avis.difficulte_gestion_erreurs);


                if (avisEnseignant.avis.commentaires && avisEnseignant.avis.commentaires.trim() !== "") {
                  if (y > pageHeight - margin - 10) {
                    doc.addPage();
                    y = margin;
                  }
                  doc.text("- Commentaire :", margin + 10, y);
                  y += 6;
                  
                  const splitCommentaires = doc.splitTextToSize(avisEnseignant.avis.commentaires, contentWidth - 20);
                  
                  if (y + (splitCommentaires.length * 5) > pageHeight - margin) {
                    doc.addPage();
                    y = margin;
                  }
                  
                  doc.text(splitCommentaires, margin + 15, y);
                  y += splitCommentaires.length * 5 + 2;
                }
                y += 4;
              }
            });
          }
        });

        doc.save(`Rapport_Classe_${state.selectedPeriod}.pdf`);
      }

      // --- Initialisation de l'application ---

      /**
       * Fonction principale qui s'exécute au chargement de la page.
       */
      function main() {
        // Attache les gestionnaires d'événements statiques
        document.getElementById('teacher-select').addEventListener('change', handleTeacherChange);
        document.getElementById('export-pdf-button').addEventListener('click', handleExportClassePDF);

        // Gestion du modal d'aide
        const helpButton = document.getElementById('help-button');
        const helpModal = document.getElementById('help-modal');
        const closeModalButton = document.getElementById('close-modal-button');

        if (helpButton && helpModal && closeModalButton) {
          helpButton.addEventListener('click', () => {
            helpModal.classList.remove('hidden');
          });

          closeModalButton.addEventListener('click', () => {
            helpModal.classList.add('hidden');
          });

          // Fermer en cliquant sur l'overlay (le fond gris)
          helpModal.addEventListener('click', (e) => {
            if (e.target === helpModal) {
              helpModal.classList.add('hidden');
            }
          });
        }

        // Lance le premier rendu de l'application
        renderApp();
      }

      // Attend que le DOM soit chargé pour exécuter le script
      document.addEventListener('DOMContentLoaded', main);

    </script>
    <!-- Fin du script JavaScript -->
  </body>
</html>